# CLMS-specific Prometheus recording rules
groups:
  - name: clms.rules
    interval: 30s
    rules:
      # Application Performance Rules
      - record: clms:http_request_duration_seconds:rate5m
        expr: rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])

      - record: clms:http_request_duration_seconds:p95:5m
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

      - record: clms:http_request_duration_seconds:p99:5m
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))

      # Request Rate Rules
      - record: clms:http_requests:rate5m
        expr: sum(rate(http_requests_total[5m])) by (method, status, path)

      - record: clms:http_requests_error_rate:5m
        expr: sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))

      # Database Performance Rules
      - record: clms:mysql_query_duration_seconds:rate5m
        expr: rate(mysql_query_duration_seconds_sum[5m]) / rate(mysql_query_duration_seconds_count[5m])

      - record: clms:mysql_connections:current
        expr: mysql_global_status_threads_connected

      - record: clms:mysql_slow_queries:rate5m
        expr: rate(mysql_global_status_slow_queries[5m])

      # Redis Performance Rules
      - record: clms:redis_memory_usage_bytes
        expr: redis_memory_used_bytes

      - record: clms:redis_connected_clients
        expr: redis_connected_clients

      - record: clms:redis_commands_processed:rate5m
        expr: rate(redis_commands_processed_total[5m])

      # System Resources Rules
      - record: clms:cpu_usage_percent
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

      - record: clms:memory_usage_percent
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100

      - record: clms:disk_usage_percent
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100

      # Business Metrics Rules
      - record: clms:active_users:5m
        expr: clms_active_users_total

      - record: clms:books_checked_out:current
        expr: clms_books_checked_out_total

      - record: clms:students_registered:current
        expr: clms_students_registered_total

      - record: clms:api_requests_per_user:5m
        expr: sum(rate(http_requests_total[5m])) by (user_id)

      # Error Budget Rules
      - record: clms:error_budget_remaining:percent
        expr: (1 - (sum(rate(http_requests_total{status=~"5.."}[30d])) / sum(rate(http_requests_total[30d])))) * 100

      - record: clms:uptime_percentage:30d
        expr: (up{job="clms-backend"} * 100)

      # Application Health Rules
      - record: clms:health_check_score
        expr: up{job="clms-backend"} * clms_database_up * clms_redis_up

      - record: clms:response_time_sla:5m
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{path!="/metrics"}[5m])) < 0.5

  - name: clms.alerts
    interval: 60s
    rules:
      # Critical Alerts
      - alert: ApplicationDown
        expr: up{job="clms-backend"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "CLMS Backend is down"
          description: "CLMS Backend has been down for more than 1 minute."

      - alert: DatabaseDown
        expr: clms_database_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Database is down"
          description: "Database connection has been down for more than 1 minute."

      - alert: RedisDown
        expr: clms_redis_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis is down"
          description: "Redis connection has been down for more than 1 minute."

      # Warning Alerts
      - alert: HighErrorRate
        expr: clms:http_requests_error_rate:5m > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} for the last 5 minutes."

      - alert: HighResponseTime
        expr: clms:http_request_duration_seconds:p95:5m > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is {{ $value }}s for the last 5 minutes."

      - alert: DatabaseSlowQueries
        expr: clms:mysql_slow_queries:rate5m > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High number of slow queries"
          description: "Database slow queries rate is {{ $value }} per second."

      - alert: HighMemoryUsage
        expr: clms:memory_usage_percent > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}% on instance {{ $labels.instance }}."

      - alert: HighCPUUsage
        expr: clms:cpu_usage_percent > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}% on instance {{ $labels.instance }}."

      - alert: DiskSpaceLow
        expr: clms:disk_usage_percent > 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Low disk space"
          description: "Disk usage is {{ $value }}% on instance {{ $labels.instance }}."

      # Business Alerts
      - alert: NoActiveUsers
        expr: clms:active_users:5m == 0
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "No active users detected"
          description: "No active users have been detected for the last 15 minutes."

      - alert: BackupFailure
        expr: time() - clms_last_backup_timestamp > 86400
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "Backup has not completed"
          description: "Last backup was more than 24 hours ago."

      # SSL Certificate Alerts
      - alert: SSLCertificateExpiringSoon
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 7
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "SSL certificate expiring soon"
          description: "SSL certificate will expire in less than 7 days."

      - alert: SSLCertificateExpired
        expr: probe_ssl_earliest_cert_expiry - time() <= 0
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "SSL certificate has expired"
          description: "SSL certificate has expired."

      # Performance Alerts
      - alert: ResponseTimeSLABreach
        expr: clms:response_time_sla:5m == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Response time SLA breach"
          description: "95th percentile response time is above 500ms SLA."

      # Health Score Alerts
      - alert: HealthScoreLow
        expr: clms:health_check_score < 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Application health score is low"
          description: "Application health score is {{ $value }} (should be 1)."

      # Rate Limiting Alerts
      - alert: HighRequestRate
        expr: sum(rate(http_requests_total[5m])) > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request rate detected"
          description: "Request rate is {{ $value }} requests per second."

      # Database Connection Pool Alerts
      - alert: DatabaseConnectionPoolExhausted
        expr: clms:mysql_connections > clms:mysql_max_connections * 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "Database connections are at {{ $value }}% of maximum."

      # Redis Memory Alerts
      - alert: RedisHighMemoryUsage
        expr: clms:redis_memory_usage_bytes / clms:redis_max_memory_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis memory usage is high"
          description: "Redis memory usage is {{ $value | humanizePercentage }} of maximum."

      # Error Budget Alerts
      - alert: ErrorBudgetExhausted
        expr: clms:error_budget_remaining:percent < 10
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "Error budget exhausted"
          description: "Error budget remaining is {{ $value }}%."

      - alert: ErrorBudgetWarning
        expr: clms:error_budget_remaining:percent < 25
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "Error budget running low"
          description: "Error budget remaining is {{ $value }}%."