generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model audit_logs {
  id             String   @id
  entity         String
  action         String
  created_at     DateTime @default(now())
  entity_id      String
  ip_address     String?  @db.Text
  new_values     Json?
  old_values     Json?
  performed_by   String   @default("Sophia")
  user_agent     String?
  ip_address_enc Json?

  @@index([action], map: "idx_audit_logs_action")
  @@index([created_at], map: "idx_audit_logs_created_at")
  @@index([entity], map: "idx_audit_logs_entity")
  @@index([entity_id], map: "idx_audit_logs_entity_id")
  @@index([performed_by], map: "idx_audit_logs_performed_by")
}

model automation_jobs {
  id                  String                 @id
  name                String                 @unique
  type                automation_jobs_type
  schedule            String
  description         String?
  status              automation_jobs_status @default(IDLE)
  config              Json?
  average_duration_ms Int?
  created_at          DateTime               @default(now())
  failure_count       Int                    @default(0)
  is_enabled          Boolean                @default(true)
  last_run_at         DateTime?
  next_run_at         DateTime?
  success_count       Int                    @default(0)
  total_runs          Int                    @default(0)
  updated_at          DateTime

  @@index([is_enabled], map: "idx_automation_jobs_is_enabled")
  @@index([next_run_at], map: "idx_automation_jobs_next_run")
  @@index([status], map: "idx_automation_jobs_status")
  @@index([type], map: "idx_automation_jobs_type")
}

model automation_logs {
  id                String                 @id
  status            automation_logs_status
  success           Boolean
  completed_at      DateTime?
  duration_ms       Int?
  error_details     Json?
  error_message     String?
  execution_id      String                 @unique
  job_id            String
  records_processed Int?
  started_at        DateTime               @default(now())
  triggered_by      String                 @default("SCHEDULED")

  @@index([job_id], map: "idx_automation_logs_job_id")
  @@index([started_at], map: "idx_automation_logs_started_at")
  @@index([status], map: "idx_automation_logs_status")
  @@index([success], map: "idx_automation_logs_success")
}

model barcode_history {
  id           String   @id
  format       String
  barcode_data String
  book_id      String?
  entity_id    String
  entity_type  String
  generated_at DateTime @default(now())
  generated_by String   @default("Sophia")
  student_id   String?

  @@index([book_id], map: "barcode_history_book_id_fkey")
  @@index([student_id], map: "barcode_history_student_id_fkey")
  @@index([entity_id], map: "idx_barcode_history_entity_id")
  @@index([entity_type], map: "idx_barcode_history_entity_type")
}

model book_checkouts {
  id            String                @id
  status        book_checkouts_status @default(ACTIVE)
  notes         String?
  book_id       String
  checkout_date DateTime              @default(now())
  created_at    DateTime              @default(now())
  due_date      DateTime
  fine_amount   Decimal               @default(0.00) @db.Decimal(10, 2)
  fine_paid     Boolean               @default(false)
  overdue_days  Int                   @default(0)
  processed_by  String                @default("Sophia")
  return_date   DateTime?
  student_id    String
  updated_at    DateTime

  @@index([book_id], map: "idx_book_checkouts_book_id")
  @@index([due_date], map: "idx_book_checkouts_due_date")
  @@index([overdue_days], map: "idx_book_checkouts_overdue_days")
  @@index([status], map: "idx_book_checkouts_status")
  @@index([student_id], map: "idx_book_checkouts_student_id")
}

model books {
  id               String   @id
  isbn             String?
  title            String   @db.VarChar(500)
  author           String   @db.VarChar(500)
  publisher        String?
  category         String
  subcategory      String?
  location         String?
  accession_no     String   @unique
  available_copies Int      @default(1)
  barcode_image    String?
  created_at       DateTime @default(now())
  is_active        Boolean  @default(true)
  total_copies     Int      @default(1)
  updated_at       DateTime
  cost_price       Float?
  edition          String?
  pages            String?
  remarks          String?  @db.Text
  source_of_fund   String?
  volume           String?
  year             Int?

  @@index([accession_no], map: "idx_books_accession_no")
  @@index([category], map: "idx_books_category")
  @@index([is_active], map: "idx_books_is_active")
}

model equipment {
  id                   String                     @id
  name                 String
  type                 equipment_type
  location             String
  status               equipment_status           @default(AVAILABLE)
  description          String?
  created_at           DateTime                   @default(now())
  equipment_id         String                     @unique
  max_time_minutes     Int
  requires_supervision Boolean                    @default(false)
  updated_at           DateTime
  purchase_date        DateTime?
  purchase_cost        Float?
  serial_number        String?                    @db.VarChar(255)
  asset_tag            String?                    @db.VarChar(255)
  warranty_expiry      DateTime?
  condition_rating     equipment_condition_rating @default(EXCELLENT)
  maintenance_interval Int?
  last_maintenance     DateTime?
  next_maintenance     DateTime?
  total_usage_hours    Float                      @default(0)
  daily_usage_hours    Float                      @default(0)
  qr_code_data         String?
  barcode_data         String?
  category             String?
  tags                 Json?
  specifications       Json?
  notes                String?                    @db.Text
  is_active            Boolean                    @default(true)
  serial_number_enc    Json?
  asset_tag_enc        Json?

  @@index([asset_tag], map: "idx_equipment_asset_tag")
  @@index([category], map: "idx_equipment_category")
  @@index([equipment_id], map: "idx_equipment_equipment_id")
  @@index([is_active], map: "idx_equipment_is_active")
  @@index([location], map: "idx_equipment_location")
  @@index([next_maintenance], map: "idx_equipment_next_maintenance")
  @@index([status], map: "idx_equipment_status")
  @@index([type], map: "idx_equipment_type")
}

model equipment_condition_reports {
  id               String                                       @id
  equipment_id     String
  condition_before equipment_condition_reports_condition_before
  condition_after  equipment_condition_reports_condition_after
  assessment_type  equipment_condition_reports_assessment_type  @default(ROUTINE)
  damage_type      String?
  damage_severity  equipment_condition_reports_damage_severity  @default(NONE)
  description      String?                                      @db.Text
  cost_estimate    Float?
  reported_by      String                                       @default("Sophia")
  assessment_date  DateTime                                     @default(now())
  resolved         Boolean                                      @default(false)
  resolution_notes String?                                      @db.Text
  created_at       DateTime                                     @default(now())
  updated_at       DateTime
  photos           Json?
  witness_names    Json?

  @@index([assessment_date], map: "idx_equipment_condition_reports_date")
  @@index([equipment_id], map: "idx_equipment_condition_reports_equipment_id")
  @@index([damage_severity], map: "idx_equipment_condition_reports_severity")
}

model equipment_maintenance {
  id                 String                                 @id
  equipment_id       String
  maintenance_type   equipment_maintenance_maintenance_type @default(ROUTINE)
  description        String?                                @db.Text
  cost               Float?
  vendor             String?
  scheduled_date     DateTime?
  completed_date     DateTime?
  status             equipment_maintenance_status           @default(SCHEDULED)
  notes              String?                                @db.Text
  created_at         DateTime                               @default(now())
  updated_at         DateTime
  performed_by       String?                                @default("Sophia")
  priority           equipment_maintenance_priority         @default(NORMAL)
  estimated_duration Int?
  actual_duration    Int?
  parts_replaced     Json?
  warranty_claim     Boolean                                @default(false)
  follow_up_required Boolean                                @default(false)
  follow_up_date     DateTime?

  @@index([equipment_id], map: "idx_equipment_maintenance_equipment_id")
  @@index([priority], map: "idx_equipment_maintenance_priority")
  @@index([scheduled_date], map: "idx_equipment_maintenance_scheduled")
  @@index([status], map: "idx_equipment_maintenance_status")
  @@index([maintenance_type], map: "idx_equipment_maintenance_type")
}

model equipment_reports {
  id            String                        @id
  equipment_id  String?
  report_type   equipment_reports_report_type @default(MONTHLY)
  report_period String
  title         String
  content       Json
  metrics       Json
  generated_by  String                        @default("Sophia")
  generated_at  DateTime                      @default(now())
  is_public     Boolean                       @default(false)
  file_path     String?
  summary       String?                       @db.Text

  @@unique([report_type, report_period, equipment_id])
  @@index([equipment_id], map: "idx_equipment_reports_equipment_id")
  @@index([report_period], map: "idx_equipment_reports_period")
  @@index([report_type], map: "idx_equipment_reports_type")
}

model equipment_reservations {
  id                  String                        @id
  equipment_id        String
  student_id          String
  reservation_date    DateTime                      @default(now())
  start_time          DateTime
  end_time            DateTime
  status              equipment_reservations_status @default(PENDING)
  purpose             String?                       @db.Text
  notes               String?                       @db.Text
  created_at          DateTime                      @default(now())
  updated_at          DateTime
  processed_by        String                        @default("Sophia")
  cancellation_reason String?                       @db.Text
  cancelled_at        DateTime?

  @@index([reservation_date], map: "idx_equipment_reservations_date")
  @@index([equipment_id], map: "idx_equipment_reservations_equipment_id")
  @@index([start_time], map: "idx_equipment_reservations_start_time")
  @@index([status], map: "idx_equipment_reservations_status")
  @@index([student_id], map: "idx_equipment_reservations_student_id")
}

model equipment_sessions {
  id              String                    @id
  status          equipment_sessions_status @default(ACTIVE)
  extensions      Int                       @default(0)
  notes           String?
  actual_duration Int?
  created_at      DateTime                  @default(now())
  equipment_id    String
  planned_end     DateTime?
  processed_by    String                    @default("Sophia")
  session_end     DateTime?
  session_start   DateTime                  @default(now())
  student_id      String
  updated_at      DateTime

  @@index([equipment_id], map: "idx_equipment_sessions_equipment_id")
  @@index([session_start], map: "idx_equipment_sessions_start")
  @@index([status], map: "idx_equipment_sessions_status")
  @@index([student_id], map: "idx_equipment_sessions_student_id")
}

model equipment_usage_stats {
  id                String   @id
  equipment_id      String
  date              DateTime @default(now())
  total_sessions    Int      @default(0)
  total_minutes     Int      @default(0)
  peak_hour_start   Int?
  peak_hour_end     Int?
  utilization_rate  Float    @default(0)
  average_session   Float    @default(0)
  issues_reported   Int      @default(0)
  revenue_generated Float?
  created_at        DateTime @default(now())
  updated_at        DateTime

  @@unique([equipment_id, date])
  @@index([date], map: "idx_equipment_usage_stats_date")
  @@index([equipment_id], map: "idx_equipment_usage_stats_equipment_id")
}

model notifications {
  id         String                 @id
  user_id    String?
  type       notifications_type
  title      String
  message    String                 @db.Text
  priority   notifications_priority @default(NORMAL)
  read       Boolean                @default(false)
  read_at    DateTime?
  action_url String?
  metadata   Json?
  created_at DateTime               @default(now())
  expires_at DateTime?

  @@index([created_at], map: "idx_notifications_created_at")
  @@index([read], map: "idx_notifications_read")
  @@index([type], map: "idx_notifications_type")
  @@index([user_id], map: "idx_notifications_user_id")
}

model student_activities {
  id                 String                             @id
  student_id         String
  student_name       String?
  grade_level        String?
  grade_category     student_activities_grade_category?
  activity_type      student_activities_activity_type
  equipment_id       String?
  checkout_id        String?
  start_time         DateTime                           @default(now())
  end_time           DateTime?
  duration_minutes   Int?
  time_limit_minutes Int?
  status             student_activities_status          @default(ACTIVE)
  notes              String?
  processed_by       String                             @default("Sophia")
  google_synced      Boolean                            @default(false)
  sync_attempts      Int                                @default(0)
  created_at         DateTime                           @default(now())
  updated_at         DateTime

  @@index([activity_type], map: "idx_student_activities_activity_type")
  @@index([google_synced], map: "idx_student_activities_google_synced")
  @@index([grade_category], map: "idx_student_activities_grade_category")
  @@index([start_time], map: "idx_student_activities_start_time")
  @@index([status], map: "idx_student_activities_status")
  @@index([student_id], map: "idx_student_activities_student_id")
  @@index([equipment_id], map: "student_activities_equipment_id_fkey")
}

model students {
  id                          String                  @id
  section                     String?                 @db.Text
  barcode_image               String?
  created_at                  DateTime                @default(now())
  first_name                  String                  @db.Text
  grade_category              students_grade_category
  grade_level                 String
  is_active                   Boolean                 @default(true)
  last_name                   String                  @db.Text
  student_id                  String                  @unique
  updated_at                  DateTime
  equipment_ban               Boolean                 @default(false)
  equipment_ban_reason        String?                 @db.Text
  equipment_ban_until         DateTime?
  fine_balance                Float                   @default(0)
  max_concurrent_reservations Int                     @default(2)
  first_name_enc              Json?
  last_name_enc               Json?
  student_id_enc              Json?
  section_enc                 Json?

  @@index([equipment_ban], map: "idx_students_equipment_ban")
  @@index([grade_category], map: "idx_students_grade_category")
  @@index([is_active], map: "idx_students_is_active")
  @@index([student_id], map: "idx_students_student_id")
}

model system_config {
  id          String   @id
  key         String   @unique
  value       String?  @db.Text
  description String?
  category    String
  created_at  DateTime @default(now())
  is_secret   Boolean  @default(false)
  updated_at  DateTime
  value_enc   Json?

  @@index([category], map: "idx_system_config_category")
}

model users {
  id            String     @id
  username      String     @unique
  password      String
  role          users_role @default(LIBRARIAN)
  created_at    DateTime   @default(now())
  is_active     Boolean    @default(true)
  last_login_at DateTime?
  updated_at    DateTime
  email         String?    @unique @db.VarChar(255)
  full_name     String?    @db.Text
  permissions   Json?
  username_enc  Json?
  email_enc     Json?
  full_name_enc Json?

  @@index([is_active], map: "idx_users_is_active")
  @@index([role], map: "idx_users_role")
}

model id_mappings {
  id            String   @id
  entity_type   String   // student, book, equipment, user, checkout
  external_id   String   // Original ID from import/external system
  internal_id   String   // UUID in our system
  created_at    DateTime @default(now())
  updated_at    DateTime
  last_accessed DateTime @default(now())
  access_count  Int      @default(0)
  is_active     Boolean  @default(true)
  metadata      Json?    // Additional information about the mapping

  @@unique([entity_type, external_id])
  @@index([entity_type], map: "idx_id_mappings_entity_type")
  @@index([external_id], map: "idx_id_mappings_external_id")
  @@index([internal_id], map: "idx_id_mappings_internal_id")
  @@index([is_active], map: "idx_id_mappings_is_active")
  @@index([last_accessed], map: "idx_id_mappings_last_accessed")
}

enum automation_logs_status {
  IDLE
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  RETRYING
}

enum book_checkouts_status {
  ACTIVE
  RETURNED
  OVERDUE
  LOST
  DAMAGED
}

enum equipment_sessions_status {
  ACTIVE
  COMPLETED
  EXPIRED
  EXTENDED
  TERMINATED
}

enum automation_jobs_type {
  DAILY_BACKUP
  TEACHER_NOTIFICATIONS
  GOOGLE_SHEETS_SYNC
  SESSION_EXPIRY_CHECK
  OVERDUE_NOTIFICATIONS
  WEEKLY_CLEANUP
  MONTHLY_REPORT
  INTEGRITY_AUDIT
}

enum equipment_type {
  COMPUTER
  GAMING
  AVR
  PRINTER
  SCANNER
  OTHER
}

enum equipment_condition_reports_condition_before {
  EXCELLENT
  GOOD
  FAIR
  POOR
  DAMAGED
}

enum equipment_maintenance_maintenance_type {
  ROUTINE
  REPAIR
  INSPECTION
  CALIBRATION
  UPGRADE
  CLEANING
}

enum equipment_reports_report_type {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
  CUSTOM
}

enum notifications_type {
  OVERDUE_BOOK
  FINE_ADDED
  FINE_WAIVED
  BOOK_DUE_SOON
  EQUIPMENT_EXPIRING
  SYSTEM_ALERT
  INFO
  WARNING
  ERROR
  SUCCESS
}

enum equipment_condition_reports_condition_after {
  EXCELLENT
  GOOD
  FAIR
  POOR
  DAMAGED
}

enum users_role {
  SUPER_ADMIN
  ADMIN
  LIBRARIAN
  ASSISTANT
  TEACHER
  VIEWER
}

enum equipment_status {
  AVAILABLE
  IN_USE
  MAINTENANCE
  OUT_OF_ORDER
  RESERVED
  RETIRED
}

enum equipment_condition_reports_assessment_type {
  ROUTINE
  DAMAGE_REPORT
  PRE_MAINTENANCE
  POST_MAINTENANCE
  ANNUAL_INSPECTION
  INCIDENT
}

enum student_activities_grade_category {
  PRIMARY
  GRADE_SCHOOL
  JUNIOR_HIGH
  SENIOR_HIGH
}

enum automation_jobs_status {
  IDLE
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  RETRYING
}

enum notifications_priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum student_activities_activity_type {
  COMPUTER_USE
  GAMING_SESSION
  AVR_SESSION
  BOOK_CHECKOUT
  BOOK_RETURN
  GENERAL_VISIT
  RECREATION
  STUDY
  OTHER
}

enum students_grade_category {
  PRIMARY
  GRADE_SCHOOL
  JUNIOR_HIGH
  SENIOR_HIGH
}

enum equipment_condition_reports_damage_severity {
  NONE
  MINOR
  MODERATE
  MAJOR
  SEVERE
  CRITICAL
}

enum equipment_reservations_status {
  PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum equipment_maintenance_status {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
  PENDING_PARTS
}

enum student_activities_status {
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELLED
  EXTENDED
}

enum equipment_maintenance_priority {
  LOW
  NORMAL
  HIGH
  URGENT
  CRITICAL
}

enum equipment_condition_rating {
  EXCELLENT
  GOOD
  FAIR
  POOR
  DAMAGED
}
