// This schema is for Prisma 7.x
// The 'url' property is standard for this version

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// SQLite doesn't support ENUMs - using String with comments for valid values
// PaperSize: "SHORT" | "LONG"
// ColorLevel: "BW" | "HALF_COLOR" | "FULL_COLOR"

model users {
  id            String    @id @default(cuid())
  username      String    @unique
  email         String?
  password      String
  role          String    @default("LIBRARIAN")
  first_name    String?
  last_name     String?
  full_name     String?
  is_active     Boolean   @default(true)
  last_login_at DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
}

// UserType: "STUDENT" | "PERSONNEL" (SQLite doesn't support ENUMs)

model students {
  id                 String               @id @default(cuid())
  student_id         String               @unique
  type               String               @default("STUDENT") // "STUDENT" | "PERSONNEL"
  first_name         String
  last_name          String
  grade_level        Int
  grade_category     String?
  section            String?
  gender             String?
  email              String?
  phone              String?
  barcode            String?              @unique
  photo_url          String?
  is_active          Boolean              @default(true)
  created_at         DateTime             @default(now())
  updated_at         DateTime             @updatedAt
  checkouts          book_checkouts[]
  activities         student_activities[]
  printing_jobs      printing_jobs[]
  equipment_sessions equipment_sessions[]
  studentScanStats   student_scan_stats[]
  monthlyRewards     monthly_rewards[]
}

model books {
  id                String              @id @default(cuid())
  isbn              String?
  title             String
  author            String
  publisher         String?
  year              Int?
  category          String?
  subcategory       String?
  location          String?
  accession_no      String              @unique
  available_copies  Int                 @default(0)
  total_copies      Int                 @default(0)
  cost_price        Float?
  edition           String?
  pages             String?
  remarks           String?
  source_of_fund    String?
  volume            String?
  is_active         Boolean             @default(true)
  needs_review      Boolean             @default(false)
  import_notes      String?
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  checkouts         book_checkouts[]
  default_policy_id String?
  default_policy    borrowing_policies? @relation("BookDefaultPolicy", fields: [default_policy_id], references: [id])
}

model book_checkouts {
  id            String    @id @default(cuid())
  book_id       String
  student_id    String
  checkout_date DateTime  @default(now())
  due_date      DateTime
  return_date   DateTime?
  status        String    @default("ACTIVE")
  fine_amount   Float     @default(0)
  notes         String?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  book           books               @relation(fields: [book_id], references: [id])
  student        students            @relation(fields: [student_id], references: [id])
  policy_id      String?
  policy         borrowing_policies? @relation(fields: [policy_id], references: [id])
  fine_policy_id String?
  fine_policy    fine_policies?      @relation(fields: [fine_policy_id], references: [id])
  fine_paid      Boolean             @default(false)
  fine_paid_at   DateTime?
}

model equipment {
  id            String               @id @default(cuid())
  name          String
  category      String?
  serial_number String?              @unique
  status        String               @default("AVAILABLE")
  purchase_date DateTime?
  is_active     Boolean              @default(true)
  notes         String?
  created_at    DateTime             @default(now())
  updated_at    DateTime             @updatedAt
  sessions      equipment_sessions[]
}

model student_activities {
  id            String                        @id @default(cuid())
  student_id    String
  activity_type String
  description   String?
  start_time    DateTime                      @default(now())
  end_time      DateTime?
  status        String                        @default("ACTIVE")
  student       students                      @relation(fields: [student_id], references: [id])
  session_id    String?
  metadata      String? // JSON stored as text in SQLite
  sections      student_activities_sections[]

  @@unique([session_id])
}

model library_sections {
  id                  String                         @id @default(cuid())
  code                String                         @unique
  name                String
  description         String?
  is_active           Boolean                        @default(true)
  created_at          DateTime                       @default(now())
  updated_at          DateTime                       @updatedAt
  activities          student_activities_sections[]
  archived_activities archived_activities_sections[]

  @@index([code])
}

model student_activities_sections {
  id          String   @id @default(cuid())
  activity_id String
  section_id  String
  created_at  DateTime @default(now())

  activity student_activities @relation(fields: [activity_id], references: [id])
  section  library_sections   @relation(fields: [section_id], references: [id])

  @@unique([activity_id, section_id])
}

model student_activities_archive {
  id              String    @id @default(cuid())
  original_id     String // Original ID from student_activities
  student_id      String
  activity_type   String
  description     String?
  start_time      DateTime
  end_time        DateTime?
  status          String
  metadata        String? // JSON stored as text in SQLite
  session_id      String?
  archived_at     DateTime  @default(now())
  archived_reason String    @default("DAILY_RESET") // DAILY_RESET, MANUAL_ARCHIVE, etc.
  archived_by     String? // User who triggered the archive
  created_at      DateTime // Original creation timestamp
  updated_at      DateTime // Original update timestamp

  sections archived_activities_sections[]

  @@index([archived_at])
  @@index([student_id])
  @@index([archived_reason])
}

model archived_activities_sections {
  id          String   @id @default(cuid())
  activity_id String
  section_id  String
  created_at  DateTime @default(now())

  activity student_activities_archive @relation(fields: [activity_id], references: [id])
  section  library_sections           @relation(fields: [section_id], references: [id])

  @@unique([activity_id, section_id])
}

model borrowing_policies {
  id                String           @id @default(cuid())
  name              String?
  category          String           @unique
  loan_days         Int
  overnight         Boolean          @default(false)
  is_active         Boolean          @default(true)
  created_at        DateTime         @default(now())
  updated_at        DateTime         @updatedAt
  checkouts         book_checkouts[]
  default_for_books books[]          @relation("BookDefaultPolicy")
}

model fine_policies {
  id           String           @id @default(cuid())
  grade_min    Int
  grade_max    Int
  rate_per_day Float
  currency     String           @default("PHP")
  is_active    Boolean          @default(true)
  created_at   DateTime         @default(now())
  updated_at   DateTime         @updatedAt
  checkouts    book_checkouts[]

  @@index([grade_min, grade_max])
}

model printing_pricing {
  id             String     @id @default(cuid())
  paper_size     String // "SHORT" | "LONG"
  color_level    String // "BW" | "HALF_COLOR" | "FULL_COLOR"
  price          Float
  currency       String     @default("PHP")
  effective_from DateTime   @default(now())
  is_active      Boolean    @default(true)
  created_at     DateTime   @default(now())
  updated_at     DateTime   @updatedAt

  @@index([paper_size, color_level])
}

model printing_jobs {
  id             String     @id @default(cuid())
  student_id     String?
  guest_name     String?
  paper_size     String // "SHORT" | "LONG"
  color_level    String // "BW" | "HALF_COLOR" | "FULL_COLOR"
  pages          Int
  price_per_page Float
  total_cost     Float
  paid           Boolean    @default(false)
  receipt_no     String?
  created_at     DateTime   @default(now())
  paid_at        DateTime?
  metadata       String? // JSON stored as text in SQLite

  student students? @relation(fields: [student_id], references: [id])

  @@index([student_id])
  @@index([created_at])
}

model announcements {
  id                  String    @id @default(cuid())
  title               String
  content             String
  start_time          DateTime
  end_time            DateTime?
  is_active           Boolean   @default(true)
  priority            String    @default("NORMAL")
  created_by_user_id  String?
  created_by_username String?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  @@index([is_active, start_time, end_time])
}

model system_settings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  category    String   @default("general")
  updated_by  String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

model error_logs {
  id         String   @id @default(cuid())
  level      String // ERROR, WARN, INFO
  message    String
  stack      String?
  userId     String?
  endpoint   String?
  method     String?
  userAgent  String?
  ipAddress  String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model app_notifications {
  id        String    @id @default(cuid())
  userId    String?
  type      String // OVERDUE_BOOK, FINE_ADDED, BOOK_DUE_SOON, etc.
  title     String
  message   String
  priority  String    @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  read      Boolean   @default(false)
  readAt    DateTime?
  actionUrl String?
  metadata  String? // JSON stored as text in SQLite
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model equipment_sessions {
  id            String    @id @default(cuid())
  equipment_id  String
  student_id    String
  session_start DateTime  @default(now())
  session_end   DateTime?
  expected_end  DateTime
  status        String    @default("ACTIVE") // ACTIVE, COMPLETED, OVERDUE, CANCELLED
  notes         String?
  supervised_by String?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  equipment equipment @relation(fields: [equipment_id], references: [id])
  student   students  @relation(fields: [student_id], references: [id])

  @@index([equipment_id])
  @@index([student_id])
  @@index([status])
}

model student_scan_stats {
  id             String   @id @default(cuid())
  student_id     String
  year           Int
  month          Int
  total_scans    Int      @default(0)
  total_minutes  Int      @default(0)
  last_scan_date DateTime @default(now())
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  student students @relation(fields: [student_id], references: [id])

  @@unique([student_id, year, month])
  @@index([year, month])
  @@index([total_scans])
}

model monthly_rewards {
  id          String   @id @default(cuid())
  student_id  String
  year        Int
  month       Int
  rank        Int
  total_scans Int
  reward_type String
  notes       String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  student students @relation(fields: [student_id], references: [id])

  @@index([year, month])
  @@index([student_id])
}

// Custom calendar events for librarian reminders
model calendar_events {
  id          String    @id @default(cuid())
  title       String
  description String?
  event_date  DateTime
  end_date    DateTime?
  event_type  String    @default("reminder") // "reminder", "holiday", "deadline", "meeting", "other"
  color       String    @default("#3b82f6") // Hex color for display
  all_day     Boolean   @default(true)
  is_active   Boolean   @default(true)
  created_by  String?
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  @@index([event_date])
  @@index([is_active])
}
