name: Documentation Quality Checks

on:
  pull_request:
    paths:
      - 'Docs/**'
      - '*.md'
      - '.github/workflows/documentation-check.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'Docs/**'
      - '*.md'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  documentation-quality:
    runs-on: ubuntu-latest
    name: Documentation Quality Checks
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          npm install -g markdownlint-cli2@0.9.0
          npm install -g markdown-link-check@3.11.2
          npm install -g prettier@3.0.0
          npm install -g cspell@7.3.8
          
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            Docs/**
            *.md
            
      - name: Check if documentation was changed
        id: docs-changed
        run: |
          if [ -n "${{ steps.changed-files.outputs.all_changed_files }}" ]; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
            echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
          else
            echo "docs_changed=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Create markdownlint config
        if: steps.docs-changed.outputs.docs_changed == 'true'
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD001": true,
            "MD003": {
              "style": "atx"
            },
            "MD004": {
              "style": "dash"
            },
            "MD007": {
              "indent": 2
            },
            "MD013": {
              "line_length": 120,
              "code_blocks": false,
              "tables": false
            },
            "MD022": {
              "lines_above": 1,
              "lines_below": 1
            },
            "MD024": {
              "allow_different_nesting": true
            },
            "MD025": {
              "front_matter_title": "^\\s*title\\s*[:=]"
            },
            "MD029": {
              "style": "ordered"
            },
            "MD033": {
              "allowed_elements": ["br", "sub", "sup", "kbd", "mark", "details", "summary"]
            },
            "MD034": false,
            "MD036": {
              "punctuation": ".,;:!ã€‚ï¼Œï¼›ï¼šï¼"
            },
            "MD041": false,
            "MD046": {
              "style": "fenced"
            }
          }
          EOF
          
      - name: Run markdownlint
        if: steps.docs-changed.outputs.docs_changed == 'true'
        run: |
          echo "ðŸ” Running markdownlint on documentation files..."
          
          # Create array of changed files
          files=(${{ steps.changed-files.outputs.all_changed_files }})
          
          # Run markdownlint on changed markdown files
          for file in "${files[@]}"; do
            if [[ "$file" == *.md ]]; then
              echo "Checking $file..."
              markdownlint-cli2 "$file" || {
                echo "âŒ Markdownlint failed for $file"
                exit 1
              }
            fi
          done
          
          echo "âœ… Markdownlint checks passed"
          
      - name: Create markdown-link-check config
        if: steps.docs-changed.outputs.docs_changed == 'true'
        run: |
          cat > .markdownlinkcheck.json << 'EOF'
          {
            "ignorePatterns": [
              {
                "pattern": "^http://localhost"
              },
              {
                "pattern": "^http://127.0.0.1"
              },
              {
                "pattern": "^https://github.com/[^/]+/[^/]+/edit/"
              },
              {
                "pattern": "^https://github.com/[^/]+/[^/]+/blob/"
              }
            ],
            "replacementPatterns": [
              {
                "pattern": "^/",
                "replacement": "https://github.com/${{ github.repository }}/tree/main/"
              }
            ],
            "timeout": "20s",
            "retryOn429": true,
            "retryCount": 3,
            "fallbackRetryDelay": "30s",
            "httpHeaders": [
              {
                "urls": ["https://github.com"],
                "headers": {
                  "Accept": "text/html",
                  "User-Agent": "markdown-link-check/3.11.2"
                }
              }
            ]
          }
          EOF
          
      - name: Run markdown-link-check
        if: steps.docs-changed.outputs.docs_changed == 'true'
        run: |
          echo "ðŸ”— Running markdown-link-check on documentation files..."
          
          # Create array of changed files
          files=(${{ steps.changed-files.outputs.all_changed_files }})
          
          # Run link check on changed markdown files
          for file in "${files[@]}"; do
            if [[ "$file" == *.md ]]; then
              echo "Checking links in $file..."
              markdown-link-check "$file" --config .markdownlinkcheck.json || {
                echo "âŒ Link check failed for $file"
                exit 1
              }
            fi
          done
          
          echo "âœ… Link checks passed"
          
      - name: Create Prettier config
        if: steps.docs-changed.outputs.docs_changed == 'true'
        run: |
          cat > .prettierrc.json << 'EOF'
          {
            "semi": true,
            "trailingComma": "es5",
            "singleQuote": true,
            "printWidth": 120,
            "tabWidth": 2,
            "useTabs": false,
            "bracketSpacing": true,
            "arrowParens": "avoid",
            "endOfLine": "lf",
            "embeddedLanguageFormatting": "auto"
          }
          EOF
          
      - name: Run Prettier formatting check
        if: steps.docs-changed.outputs.docs_changed == 'true'
        run: |
          echo "ðŸŽ¨ Running Prettier formatting check..."
          
          # Create array of changed files
          files=(${{ steps.changed-files.outputs.all_changed_files }})
          
          # Check formatting of changed files
          for file in "${files[@]}"; do
            if [[ "$file" == *.md || "$file" == *.json || "$file" == *.yml || "$file" == *.yaml ]]; then
              echo "Checking formatting of $file..."
              prettier --check "$file" || {
                echo "âŒ Formatting check failed for $file"
                echo "Run 'prettier --write $file' to fix formatting"
                exit 1
              }
            fi
          done
          
          echo "âœ… Formatting checks passed"
          
      - name: Create cspell config
        if: steps.docs-changed.outputs.docs_changed == 'true'
        run: |
          cat > .cspell.json << 'EOF'
          {
            "version": "0.2",
            "language": "en,en-US",
            "words": [
              "CLMS",
              "markdownlint",
              "prettier",
              "cspell",
              "trivy",
              "CODEOWNERS",
              "FERPA",
              "GDPR",
              "RBAC",
              "JWT",
              "MFA",
              "TOTP",
              "SSO",
              "API",
              "REST",
              "CRUD",
              "CI/CD",
              "Docker",
              "Kubernetes",
              "Redis",
              "MySQL",
              "Nginx",
              "SSL",
              "TLS",
              "HTTPS",
              "HTTP",
              "URL",
              "URI",
              "JSON",
              "YAML",
              "XML",
              "HTML",
              "CSS",
              "JavaScript",
              "TypeScript",
              "Nodejs",
              "React",
              "GitHub",
              "GitLab",
              "Jenkins",
              "Prometheus",
              "Grafana",
              "Lunr",
              "Algolia",
              "Netlify",
              "Vercel",
              "Plausible",
              "Atlassian",
              "GitBook",
              "diffoscope",
              "fdupes",
              "docstrum",
              "pathlib",
              "spaCy",
              "difflib",
              "openai",
              "Loom",
              "CODEOWNERS",
              "git-crypt",
              "markdownlint-cli2",
              "markdown-link-check",
              "frontmatter",
              "submodules",
              "backups",
              "onboarding",
              "checklists",
              "playbooks",
              "dashboards",
              "analytics",
              "metrics",
              "logs",
              "audits",
              "compliance",
              "security",
              "performance",
              "deployment",
              "documentation",
              "repository",
              "workflow",
              "automation",
              "monitoring",
              "alerting",
              "incident",
              "response",
              "maintenance",
              "updates",
              "versioning",
              "branching",
              "merging",
              "releases",
              "sprints",
              "backlog",
              "roadmap",
              "milestones",
              "deliverables",
              "stakeholders",
              "contributors",
              "maintainers",
              "reviewers",
              "approvers",
              "assignees",
              "subscribers",
              "notifications",
              "reminders",
              "deadlines",
              "timelines",
              "schedules",
              "calendars",
              "meetings",
              "agendas",
              "minutes",
              "action",
              "items",
              "tasks",
              "stories",
              "epics",
              "features",
              "bugs",
              "issues",
              "tickets",
              "requests",
              "proposals",
              "specifications",
              "requirements",
              "designs",
              "mockups",
              "prototypes",
              "wireframes",
              "user",
              "stories",
              "personas",
              "scenarios",
              "use",
              "cases",
              "test",
              "cases",
              "unit",
              "tests",
              "integration",
              "tests",
              "end",
              "to",
              "end",
              "tests",
              "acceptance",
              "tests",
              "regression",
              "tests",
              "performance",
              "tests",
              "load",
              "tests",
              "stress",
              "tests",
              "security",
              "tests",
              "penetration",
              "tests",
              "vulnerability",
              "scans",
              "code",
              "reviews",
              "pair",
              "programming",
              "mob",
              "programming",
              "agile",
              "scrum",
              "kanban",
              "waterfall",
              "lean",
              "devops",
              "devsecops",
              "continuous",
              "integration",
              "continuous",
              "deployment",
              "continuous",
              "delivery",
              "infrastructure",
              "as",
              "code",
              "platform",
              "as",
              "service",
              "software",
              "as",
              "service",
              "infrastructure",
              "as",
              "code",
              "gitops",
              "site",
              "reliability",
              "engineering",
              "observability",
              "monitoring",
              "logging",
              "tracing",
              "metrics",
              "dashboards",
              "alerts",
              "notifications",
              "escalations",
              "runbooks",
              "playbooks",
              "procedures",
              "policies",
              "standards",
              "guidelines",
              "best",
              "practices",
              "patterns",
              "anti",
              "patterns",
              "refactoring",
              "optimization",
              "scalability",
              "availability",
              "reliability",
              "maintainability",
              "usability",
              "accessibility",
              "internationalization",
              "localization",
              "globalization",
              "compatibility",
              "interoperability",
              "portability",
              "extensibility",
              "modularity",
              "reusability",
              "testability",
              "deployability",
              "configurability",
              "customizability",
              "flexibility",
              "adaptability",
              "resilience",
              "robustness",
              "stability",
              "consistency",
              "uniformity",
              "standardization",
              "normalization",
              "optimization",
              "efficiency",
              "effectiveness",
              "productivity",
              "quality",
              "excellence",
              "innovation",
              "creativity",
              "collaboration",
              "communication",
              "coordination",
              "cooperation",
              "teamwork",
              "leadership",
              "management",
              "governance",
              "oversight",
              "supervision",
              "mentoring",
              "coaching",
              "training",
              "education",
              "learning",
              "development",
              "growth",
              "improvement",
              "enhancement",
              "advancement",
              "progress",
              "achievement",
              "success",
              "failure",
              "mistakes",
              "errors",
              "issues",
              "problems",
              "challenges",
              "obstacles",
              "barriers",
              "constraints",
              "limitations",
              "restrictions",
              "requirements",
              "specifications",
              "criteria",
              "standards",
              "metrics",
              "key",
              "performance",
              "indicators",
              "KPIs",
              "objectives",
              "goals",
              "targets",
              "outcomes",
              "deliverables",
              "outputs",
              "results",
              "impacts",
              "benefits",
              "value",
              "worth",
              "importance",
              "significance",
              "priority",
              "urgency",
              "necessity",
              "essential",
              "critical",
              "vital",
              "critical",
              "path",
              "success",
              "factors",
              "dependencies",
              "prerequisites",
              "assumptions",
              "constraints",
              "risks",
              "mitigations",
              "contingencies",
              "alternatives",
              "options",
              "choices",
              "decisions",
              "recommendations",
              "suggestions",
              "advice",
              "guidance",
              "direction",
              "strategy",
              "tactics",
              "plans",
              "planning",
              "scheduling",
              "estimation",
              "budgeting",
              "resourcing",
              "staffing",
              "team",
              "composition",
              "roles",
              "responsibilities",
              "accountabilities",
              "authorities",
              "empowerment",
              "delegation",
              "assignment",
              "allocation",
              "distribution",
              "sharing",
              "collaboration",
              "partnership",
              "alliance",
              "cooperation",
              "coordination",
              "integration",
              "alignment",
              "synchronization",
              "harmonization",
              "standardization",
              "unification",
              "consolidation",
              "centralization",
              "decentralization",
              "distribution",
              "dispersion",
              "aggregation",
              "collection",
              "gathering",
              "assembly",
              "integration",
              "combination",
              "merger",
              "acquisition",
              "takeover",
              "partnership",
              "joint",
              "venture",
              "collaboration",
              "cooperation",
              "teamwork",
              "synergy",
              "collaboration",
              "coordination",
              "cooperation",
              "integration",
              "alignment",
              "synchronization",
              "harmonization"
            ],
            "ignorePaths": [
              "node_modules/**",
              ".git/**",
              "dist/**",
              "build/**",
              "coverage/**",
              "*.log",
              "*.tmp"
            ]
          }
          EOF
          
      - name: Run spell check
        if: steps.docs-changed.outputs.docs_changed == 'true'
        run: |
          echo "ðŸ”¤ Running spell check on documentation files..."
          
          # Create array of changed files
          files=(${{ steps.changed-files.outputs.all_changed_files }})
          
          # Run spell check on changed markdown files
          for file in "${files[@]}"; do
            if [[ "$file" == *.md ]]; then
              echo "Checking spelling in $file..."
              cspell "$file" --config .cspell.json || {
                echo "âŒ Spell check failed for $file"
                echo "Add missing words to .cspell.json if they are correct"
                exit 1
              }
            fi
          done
          
          echo "âœ… Spell checks passed"
          
      - name: Check document structure
        if: steps.docs-changed.outputs.docs_changed == 'true'
        run: |
          echo "ðŸ“ Checking document structure..."
          
          # Check if required files exist
          required_files=(
            "Docs/README.md"
            "Docs/SEC_DOCUMENTATION_ACCESS_POLICY.md"
            "Docs/archive/INDEX.md"
            "Docs/DEPLOYMENT_COMPREHENSIVE_GUIDE.md"
            "Docs/PERFORMANCE_COMPREHENSIVE_GUIDE.md"
            "Docs/SECURITY_COMPREHENSIVE_GUIDE.md"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file $file is missing"
              exit 1
            fi
          done
          
          # Check if archive directory exists
          if [ ! -d "Docs/archive" ]; then
            echo "âŒ Docs/archive directory is missing"
            exit 1
          fi
          
          # Check if .github directory exists
          if [ ! -d ".github" ]; then
            echo "âŒ .github directory is missing"
            exit 1
          fi
          
          # Check if CODEOWNERS exists
          if [ ! -f ".github/CODEOWNERS" ]; then
            echo "âŒ .github/CODEOWNERS file is missing"
            exit 1
          fi
          
          echo "âœ… Document structure checks passed"
          
      - name: Generate documentation quality report
        if: steps.docs-changed.outputs.docs_changed == 'true'
        run: |
          echo "ðŸ“Š Generating documentation quality report..."
          
          # Create array of changed files
          files=(${{ steps.changed-files.outputs.all_changed_files }})
          
          # Count different types of files
          markdown_files=0
          other_files=0
          
          for file in "${files[@]}"; do
            if [[ "$file" == *.md ]]; then
              ((markdown_files++))
            else
              ((other_files++))
            fi
          done
          
          # Create quality report
          cat > documentation-quality-report.md << EOF
          # Documentation Quality Report
          
          **Generated**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")  
          **Commit**: ${{ github.sha }}  
          **Branch**: ${{ github.ref_name }}  
          **Actor**: ${{ github.actor }}  
          
          ## Summary
          
          - **Total files changed**: ${{ steps.changed-files.outputs.all_changed_files_count }}
          - **Markdown files**: $markdown_files
          - **Other files**: $other_files
          
          ## Quality Checks
          
          âœ… Markdownlint - Passed  
          âœ… Link checking - Passed  
          âœ… Formatting check - Passed  
          âœ… Spell check - Passed  
          âœ… Document structure - Passed  
          
          ## Changed Files
          
          ${{ steps.changed-files.outputs.all_changed_files }}
          
          ---
          
          *This report was automatically generated by GitHub Actions*
          EOF
          
          echo "âœ… Documentation quality report generated"
          
      - name: Upload quality report
        if: steps.docs-changed.outputs.docs_changed == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: documentation-quality-report
          path: documentation-quality-report.md
          retention-days: 30
          
      - name: Comment PR with quality report
        if: steps.docs-changed.outputs.docs_changed == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            if (fs.existsSync('documentation-quality-report.md')) {
              const report = fs.readFileSync('documentation-quality-report.md', 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }
            
      - name: Summary
        if: steps.docs-changed.outputs.docs_changed == 'true'
        run: |
          echo "## Documentation Quality Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All documentation quality checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Markdownlint" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Link checking" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Formatting check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Spell check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Document structure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Changed:" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changed-files.outputs.all_changed_files_count }}" >> $GITHUB_STEP_SUMMARY
          
          # Upload quality report as artifact
          echo "### Quality Report:" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [Download Quality Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY