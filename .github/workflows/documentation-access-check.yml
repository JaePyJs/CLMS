name: Documentation Access Check

on:
  pull_request:
    paths:
      - 'Docs/**'
      - '*.md'
      - '.github/CODEOWNERS'
  push:
    branches:
      - main
      - develop
    paths:
      - 'Docs/**'
      - '*.md'
      - '.github/CODEOWNERS'

jobs:
  check-documentation-permissions:
    runs-on: ubuntu-latest
    name: Check Documentation Permissions
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            Docs/**
            *.md
            .github/CODEOWNERS
            
      - name: Check if documentation was changed
        id: docs-changed
        run: |
          if [ -n "${{ steps.changed-files.outputs.all_changed_files }}" ]; then
            echo "docs_changed=true" >> $GITHUB_OUTPUT
          else
            echo "docs_changed=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Check user permissions
        if: steps.docs-changed.outputs.docs_changed == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo, actor } = context.repo;
            
            // Get the changed files
            const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split('\n').filter(f => f.trim());
            
            // Check if any security documentation was changed
            const securityFiles = changedFiles.filter(file => 
              file.includes('SECURITY') || 
              file.includes('security') ||
              file.includes('AUTH_SECURITY') ||
              file.includes('network-security')
            );
            
            // Get repository collaborators
            const { data: collaborators } = await github.rest.repos.listCollaborators({
              owner,
              repo,
              affiliation: 'all'
            });
            
            // Get CODEOWNERS content
            let codeowners = '';
            try {
              const { data: codeownersContent } = await github.rest.repos.getContent({
                owner,
                repo,
                path: '.github/CODEOWNERS'
              });
              codeowners = Buffer.from(codeownersContent.content, 'base64').toString();
            } catch (error) {
              console.log('CODEOWNERS file not found');
            }
            
            // Check if user has appropriate permissions
            const userPermissions = collaborators.find(collab => collab.login === actor);
            const hasAdminAccess = userPermissions?.permissions?.admin;
            const hasWriteAccess = userPermissions?.permissions?.push;
            
            // Check CODEOWNERS for documentation
            const isDocumentationOwner = codeowners.includes('@clms-documentation-team') || 
                                         codeowners.includes('@clms-admins');
            
            // Check CODEOWNERS for security
            const isSecurityOwner = codeowners.includes('@clms-security-team') || 
                                    codeowners.includes('@clms-admins');
            
            // Security documentation requires security team approval
            if (securityFiles.length > 0) {
              if (!isSecurityOwner) {
                core.warning('Security documentation changed but no security team owner found in CODEOWNERS');
              }
              
              // Check if actor is in security team or admin
              const { data: teams } = await github.rest.teams.list({
                org: owner,
                per_page: 100
              });
              
              const securityTeam = teams.find(team => team.name === 'clms-security-team');
              const adminTeam = teams.find(team => team.name === 'clms-admins');
              
              let isInSecurityTeam = false;
              let isInAdminTeam = false;
              
              if (securityTeam) {
                const { data: securityMembers } = await github.rest.teams.listMembers({
                  org: owner,
                  team_slug: securityTeam.slug,
                  per_page: 100
                });
                isInSecurityTeam = securityMembers.some(member => member.login === actor);
              }
              
              if (adminTeam) {
                const { data: adminMembers } = await github.rest.teams.listMembers({
                  org: owner,
                  team_slug: adminTeam.slug,
                  per_page: 100
                });
                isInAdminTeam = adminMembers.some(member => member.login === actor);
              }
              
              if (!isInSecurityTeam && !isInAdminTeam && !hasAdminAccess) {
                core.setFailed(`User ${actor} does not have permission to modify security documentation`);
                return;
              }
            }
            
            // Regular documentation requires documentation team approval
            if (!hasAdminAccess && !hasWriteAccess) {
              const { data: teams } = await github.rest.teams.list({
                org: owner,
                per_page: 100
              });
              
              const docTeam = teams.find(team => team.name === 'clms-documentation-team');
              const adminTeam = teams.find(team => team.name === 'clms-admins');
              
              let isInDocTeam = false;
              let isInAdminTeam = false;
              
              if (docTeam) {
                const { data: docMembers } = await github.rest.teams.listMembers({
                  org: owner,
                  team_slug: docTeam.slug,
                  per_page: 100
                });
                isInDocTeam = docMembers.some(member => member.login === actor);
              }
              
              if (adminTeam) {
                const { data: adminMembers } = await github.rest.teams.listMembers({
                  org: owner,
                  team_slug: adminTeam.slug,
                  per_page: 100
                });
                isInAdminTeam = adminMembers.some(member => member.login === actor);
              }
              
              if (!isInDocTeam && !isInAdminTeam) {
                core.setFailed(`User ${actor} does not have permission to modify documentation`);
                return;
              }
            }
            
            console.log(`✅ User ${actor} has appropriate permissions for documentation changes`);
            
            // Log the access check for audit purposes
            const accessLog = {
              timestamp: new Date().toISOString(),
              user: actor,
              files: changedFiles,
              hasSecurityFiles: securityFiles.length > 0,
              permissions: {
                admin: hasAdminAccess,
                write: hasWriteAccess
              }
            };
            
            console.log('Access log:', JSON.stringify(accessLog, null, 2));

  validate-documentation:
    runs-on: ubuntu-latest
    name: Validate Documentation
    needs: check-documentation-permissions
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install -g markdownlint-cli2
          npm install -g markdown-link-check
          
      - name: Lint markdown files
        run: |
          find Docs/ -name "*.md" -exec markdownlint-cli2 {} +
          find . -maxdepth 1 -name "*.md" -exec markdownlint-cli2 {} +
          
      - name: Check links
        run: |
          find Docs/ -name "*.md" -exec markdown-link-check {} +
          find . -maxdepth 1 -name "*.md" -exec markdown-link-check {} +
          
      - name: Validate documentation structure
        run: |
          # Check if README.md exists in Docs/
          if [ ! -f "Docs/README.md" ]; then
            echo "❌ Docs/README.md is missing"
            exit 1
          fi
          
          # Check if archive directory exists
          if [ ! -d "Docs/archive" ]; then
            echo "❌ Docs/archive directory is missing"
            exit 1
          fi
          
          # Check if security access policy exists
          if [ ! -f "Docs/SEC_DOCUMENTATION_ACCESS_POLICY.md" ]; then
            echo "❌ Security access policy is missing"
            exit 1
          fi
          
          echo "✅ Documentation structure validation passed"

  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan
    needs: check-documentation-permissions
    if: contains(github.event.pull_request.changed_files, 'SECURITY')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Run Trivy security scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
          
      - name: Check for secrets in documentation
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD