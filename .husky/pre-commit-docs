#!/bin/sh
# Documentation pre-commit hook
# Runs documentation checks before allowing commits

set -e

echo "ğŸ“š Running documentation pre-commit checks..."

# Check if documentation files were modified
DOCS_CHANGED=$(git diff --cached --name-only | grep -E '\.(md|tsx?|js)$' | wc -l)

if [ "$DOCS_CHANGED" -eq 0 ]; then
  echo "âœ… No documentation changes detected"
  exit 0
fi

echo "ğŸ“ Documentation changes detected, running health checks..."

# Check for critical documentation files
if [ ! -f "CLAUDE.md" ]; then
  echo "âŒ CLAUDE.md is missing - cannot commit without critical documentation"
  exit 1
fi

if [ ! -f "README.md" ]; then
  echo "âŒ README.md is missing - cannot commit without critical documentation"
  exit 1
fi

# Check documentation syntax
if ! grep -q "## Project Overview" CLAUDE.md; then
  echo "âŒ CLAUDE.md is missing Project Overview section"
  exit 1
fi

if ! grep -q "## Technology Stack" CLAUDE.md; then
  echo "âŒ CLAUDE.md is missing Technology Stack section"
  exit 1
fi

if ! grep -q "## Development Commands" CLAUDE.md; then
  echo "âŒ CLAUDE.md is missing Development Commands section"
  exit 1
fi

# Check TypeScript compilation for documentation-related files
echo "ğŸ” Checking TypeScript compilation..."

cd Backend
if ! npx tsc --noEmit --skipLibCheck src/services/documentationService.ts src/routes/utilities.ts 2>/dev/null; then
  echo "âŒ Documentation service TypeScript compilation failed"
  exit 1
fi

cd ../Frontend
if ! npx tsc --noEmit --skipLibCheck src/components/dashboard/DocumentationDashboard.tsx 2>/dev/null; then
  echo "âŒ Documentation dashboard TypeScript compilation failed"
  exit 1
fi

cd ..

# Run quick documentation update if script is available
if [ -f "Backend/src/scripts/updateDocumentation.ts" ] && [ -d "Backend/node_modules" ]; then
  echo "ğŸ”„ Running quick documentation update..."
  cd Backend
  if npm run docs:update >/dev/null 2>&1; then
    echo "âœ… Documentation updated successfully"

    # Add any changes made by the update script
    git add CLAUDE.md README.md *.md 2>/dev/null || true
  else
    echo "âš ï¸ Documentation update failed, but proceeding with commit"
  fi
  cd ..
fi

echo "âœ… All documentation pre-commit checks passed!"

# Optional: Show documentation summary
echo ""
echo "ğŸ“Š Documentation Summary:"
echo "  - CLAUDE.md: âœ… Present and valid"
echo "  - README.md: âœ… Present"
echo "  - Documentation Service: âœ… Compiles"
echo "  - Documentation Dashboard: âœ… Compiles"
echo ""