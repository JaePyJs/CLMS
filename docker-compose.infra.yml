version: "3.9"
services:
  # ============================================================================
  # MySQL Database - Primary Data Store
  # ============================================================================
  mysql:
    image: mysql:8.0
    container_name: clms-mysql-dev
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: clms_root_password
      MYSQL_DATABASE: clms_database
      MYSQL_USER: clms_user
      MYSQL_PASSWORD: clms_password
      MYSQL_CHARACTER_SET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    ports:
      - "3308:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
      - ./docker/mysql/conf.d:/etc/mysql/conf.d
    networks:
      - clms-network
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-p$$MYSQL_ROOT_PASSWORD",
        ]
      timeout: 20s
      retries: 10
      interval: 30s
      start_period: 40s
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max_connections=200
      --log-bin-trust-function-creators=1

  # ============================================================================
  # Redis - Caching & Job Queue
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: clms-redis-dev
    restart: unless-stopped
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    networks:
      - clms-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      timeout: 10s
      retries: 5
      interval: 30s
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru

  # ============================================================================
  # Adminer - Database Management UI (Development Only)
  # ============================================================================
  adminer:
    image: adminer:latest
    container_name: clms-adminer-dev
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      ADMINER_DEFAULT_SERVER: mysql
      ADMINER_DESIGN: pepa-linha
    networks:
      - clms-network
    depends_on:
      mysql:
        condition: service_healthy
    profiles:
      - debug

# ============================================================================
# Named Volumes - Persistent Data Storage
# ============================================================================
volumes:
  mysql_data:
    driver: local
    name: clms_mysql_data_dev
  redis_data:
    driver: local
    name: clms_redis_data_dev

# ============================================================================
# Custom Network - Service Isolation
# ============================================================================
networks:
  clms-network:
    driver: bridge
    name: clms_network_dev
    ipam:
      config:
        - subnet: 172.20.0.0/16
