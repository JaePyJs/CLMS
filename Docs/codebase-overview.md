# CLMS Codebase Overview

This document summarizes the architecture, features, and file layout of the Comprehensive Library Management System (CLMS). Use it as a starting point when onboarding new contributors or refreshing your memory after stepping away from the project.

## 1. High-Level Summary

CLMS is a full-stack platform for managing school library operations. It combines an Express/TypeScript API, a Vite/React dashboard, background automation (Redis + Bull), and Google Sheets integrations to support:

- Student, book, and equipment inventory management with Prisma/MySQL persistence.
- Authentication, RBAC, and audit logging for staff actions.
- Automated barcode/QR generation, printing, and syncing with Google Sheets.
- Queue-based automation for scheduled jobs, notifications, and background imports.
- USB and camera scanning workflows for books/equipment check-in/out.

## 2. Runtime Architecture

- **Frontend:** Vite + React 18 SPA with TanStack Query, Zustand, Shadcn UI components, and Sonner toasts. Runs at `http://localhost:3000` in dockerized deployments.
- **Backend API:** Express app written in TypeScript (`Backend/src`), compiled to `dist/`. Provides REST endpoints under `/api/*` with auth middleware, validation, and structured logging.
- **Database:** MySQL 8.0 via Prisma ORM. Optional Koha read-only mirror for legacy data imports.
- **Cache/Jobs:** Redis 7 with Bull queues for automation workflows (scheduled sync, report generation, etc.).
- **External Services:** Google Sheets API for roster synchronization and barcode/QR export. USB scanner support is achieved client-side via ZXing; no camera dependency.
- **Containers:** `docker-compose.yml` orchestrates MySQL, Redis, Koha, Backend, Frontend, and Adminer services on a shared bridge network.

## 3. Project Structure (Top-Level)

```text
CLMS/
├── Backend/            # Express API, CLI scripts, Prisma schema, build artifacts
├── Frontend/           # React dashboard, tests, assets
├── Docs/               # Additional documentation (setup guides, this overview)
├── scripts/            # Standalone Node utilities outside the TS build pipeline
├── docker/             # Container configuration for MySQL, Redis, Koha
├── Current_Students.json
├── docker-compose.yml
├── README.md
└── *.md                # Feature guides (barcode, QR, USB scanner, etc.)
```

### Backend (`Backend/`)

```text
Backend/
├── package.json            # Build/test scripts & dependencies
├── tsconfig.json           # TS configuration (paths, module resolution)
├── Dockerfile              # Backend container image
├── prisma/schema.prisma    # Database schema & relations
├── src/
│   ├── app.ts              # Express app bootstrap (middleware, routes, services)
│   ├── server.ts           # HTTP server entrypoint
│   ├── cli/                # Interactive CLI for admin utilities
│   ├── middleware/         # Auth, validation, error handling
│   ├── routes/             # Route handlers grouped by domain (students, books, utilities, ...)
│   ├── services/           # Business logic (barcode, QR, automation, Google Sheets, etc.)
│   ├── utils/              # Logger, Prisma client wrapper, custom errors
│   ├── tests/              # Vitest suites for API and services
│   ├── types/              # Shared TypeScript interfaces
│   └── uploads/            # Generated artifacts (barcodes, QR sheets)
├── scripts/                # TS scripts run via `tsx` for seeding, imports, generation
├── dist/                   # Build output (generated by `npm run build`)
└── logs/                   # Structured application logs (rotated by Winston)
```

Key backend capabilities:

- **Authentication:** `authRoutes`, JWT-based tokens, password hashing (`bcryptjs`), and route-level guards (`authMiddleware`).
- **Data Domains:** Students, books, equipment, activities, automation workflows, admin configuration, reporting, and scanning operations.
- **Barcode/QR Services:** `services/barcodeService.ts` and `services/qrCodeService.ts` support batch generation, metadata reports, printable HTML sheets, and CLI exports for physical distribution.
- **Automation:** `services/automation.ts` orchestrates Bull queues and cron schedules for syncing with Google Sheets, regenerating assets, and other background tasks.
- **Integrations:** `services/googleSheets.ts` and `scripts/sync-qr-to-sheets.ts` bridge the system with Google Sheets using service accounts (`google-credentials.json`).
- **Validation & Error Handling:** Centralized `validationMiddleware`, `utils/errors.ts`, and `middleware` ensure consistent API responses and logging.

### Frontend (`Frontend/`)

```text
Frontend/
├── package.json             # Frontend build/test scripts & deps
├── vite.config.ts           # Vite bundler config (aliases, plugins)
├── src/
│   ├── main.tsx             # App bootstrap with providers
│   ├── App.tsx              # Route-less UI composition (tabbed layout)
│   ├── components/
│   │   ├── dashboard/       # Feature modules (Analytics, BarcodeManager, QRCodeManager, ScanWorkspace, etc.)
│   │   ├── auth/            # Login form and guards
│   │   └── ui/              # Reusable Shadcn primitives
│   ├── hooks/api-hooks.ts   # TanStack Query hooks for backend endpoints
│   ├── lib/                 # API client (Axios), offline queue, scanner utilities
│   ├── contexts/AuthContext.tsx  # Authentication state management
│   ├── store/useAppStore.ts # Zustand store for global UI state
│   └── test/                # Vitest + Testing Library suites
├── public/                  # Static assets served by Vite
└── tailwind.config.js       # Styling tokens & presets
```

Frontend highlights:

- **Dashboard Layout:** `App.tsx` renders tabs for dashboards, barcode/QR managers, and scanning workspace with keyboard shortcuts for rapid navigation.
- **State Management:** `AuthContext` + TanStack Query caches server data; Zustand handles UI preferences and offline data.
- **Scanning:** `lib/scanner.ts` and `components/dashboard/ScanWorkspace.tsx` support USB scanners via ZXing, parsing barcode/QR inputs without needing a camera feed.
- **Barcode/QR Management:** Dedicated components (`BarcodeManager.tsx`, `QRCodeManager.tsx`) allow batch generation, downloading printable sheets, and reconciling Google Sheets data.
- **Notifications & Themes:** Sonner toasts, theme switching via `ThemeToggle.tsx`, and Recharts-based analytics dashboards.

### Docs (`Docs/`)

Contains setup guides such as `database-setup.md`, `BARCODE_GUIDE.md`, `QR_CODE_GUIDE.md`, and this `codebase-overview.md` to help operators reproduce the environment.

### Scripts (`scripts/`)

Contains Node utilities independent of the TypeScript build, e.g. `create-current-students.js` and data migration helpers. Use these for one-off maintenance tasks.

### Docker (`docker/`)

Container configuration, including MySQL `my.cnf`, Redis `redis.conf`, and optional Koha database seeders. Referenced by `docker-compose.yml`.

## 4. Key Workflows

- **Local Development:**

  1. Install dependencies in `Backend/` and `Frontend/` (`npm install`).
  2. Run `docker-compose up` to start MySQL, Redis, and optional Koha instances.
  3. Launch backend via `npm run dev` (Backend) and frontend via `npm run dev` (Frontend).

- **Database Management:** Use Prisma commands (`db:generate`, `db:push`, `db:migrate`) and `prisma studio` for inspection. Seed data with `npm run db:seed`.

- **Barcode/QR Generation:**

  - CLI scripts: `npm run generate:barcodes`, `npm run generate:qr` produce PNGs, JSON reports, and printable `index.html` sheets under `Backend/barcodes/students` or `Backend/qr-codes/students`.
  - REST endpoints exposed under `/api/utilities/barcodes/*` and `/api/utilities/qr/*` for UI-driven generation and syncing.

- **Automation & Sync:** Bull queues orchestrate scheduled sync with Google Sheets and housekeeping tasks (see `services/automation.ts`). Cron expressions are customizable within the service configuration.

- **Testing:** Vitest suites exist for backend services (`Backend/src/tests`) and frontend components (`Frontend/src/test`). Execute with `npm test` in each package.

## 5. Environment & Configuration

- Environment variables are managed via `.env` (not committed). Required values include database credentials, JWT secrets, Google service account paths, and rate limit settings.
- Docker compose exports `DATABASE_URL`, `KOHA_DATABASE_URL`, `REDIS_HOST`, `CORS_ORIGIN`, and Vite API URLs.
- Google integrations require `google-credentials.json` mounted into the backend container.

## 6. Onboarding Checklist

1. Install Node.js >= 18 and Docker Desktop.
2. Copy `.env.example` to `.env` in `Backend/` (and `Frontend/` if applicable).
3. Run `npm install` for both backend and frontend packages.
4. Start supporting services: `docker-compose up -d mysql redis adminer koha-mysql`.
5. Run backend migrations: `npm run db:push` followed by `npm run db:seed`.
6. Launch backend (`npm run dev`) and frontend (`npm run dev`).
7. Verify health check at `http://localhost:3001/health` and login through `http://localhost:5173`.
8. Generate test barcodes/QRs via CLI or UI to ensure assets are produced.

## 7. Reference Material

- `README.md` (root): Quickstart instructions for the overall project.
- `Backend/README.md`: Backend-specific environment setup, API testing, and deployment notes.
- `Frontend/README.md`: Frontend build steps, linting, and test coverage instructions.
- Feature guides in root: `BARCODE_GUIDE.md`, `BARCODE_IMPLEMENTATION_SUMMARY.md`, `QR_CODE_GUIDE.md`, `USB_SCANNER_SETUP.md` for in-depth workflows.

---

For deeper dives into specific domains, inspect the route/service pairings under `Backend/src` and corresponding React components/hooks under `Frontend/src`. Keep this document updated whenever new modules or infrastructure components are added.
