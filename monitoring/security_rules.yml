# ============================================================================
# CLMS Security Monitoring Alert Rules
# ============================================================================
# Purpose: Security-specific monitoring and threat detection
# Network: 192.168.1.0/24 local security monitoring
# Features: Brute force detection, unusual access patterns, security events
# ============================================================================

groups:
  # Authentication Security Alerts
  - name: clms.security.auth
    rules:
      - alert: BruteForceAttackDetected
        expr: rate(login_failed_total[5m]) > 10
        for: 2m
        labels:
          severity: critical
          category: authentication
        annotations:
          summary: "Brute force attack detected"
          description: "{{ $value }} failed login attempts per minute from {{ $labels.client_ip }}"

      - alert: SuspiciousLoginPattern
        expr: increase(login_successful_total{user="admin"}[5m]) > 5
        for: 2m
        labels:
          severity: warning
          category: authentication
        annotations:
          summary: "Suspicious admin login pattern"
          description: "Multiple admin logins detected from {{ $labels.client_ip }}"

      - alert: ConcurrentSessionsExceeded
        expr: user_concurrent_sessions > 5
        for: 5m
        labels:
          severity: warning
          category: authentication
        annotations:
          summary: "Concurrent sessions exceeded"
          description: "User {{ $labels.user }} has {{ $value }} concurrent sessions"

      - alert: AuthenticationFromNewLocation
        expr: increase(login_from_new_location_total[1h]) > 0
        for: 1m
        labels:
          severity: info
          category: authentication
        annotations:
          summary: "Login from new location detected"
          description: "User {{ $labels.user }} logged in from new location {{ $labels.location }}"

  # Web Application Security Alerts
  - name: clms.security.web
    rules:
      - alert: SuspiciousUserAgent
        expr: increase(http_requests_with_suspicious_ua_total[5m]) > 5
        for: 2m
        labels:
          severity: warning
          category: web
        annotations:
          summary: "Suspicious user agent detected"
          description: "Suspicious user agent {{ $labels.user_agent }} making requests to {{ $labels.endpoint }}"

      - alert: SQLInjectionAttempt
        expr: increase(sql_injection_attempts_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          category: web
        annotations:
          summary: "SQL injection attempt detected"
          description: "SQL injection attempt from {{ $labels.client_ip }} to {{ $labels.endpoint }}"

      - alert: XSSAttempt
        expr: increase(xss_attempts_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          category: web
        annotations:
          summary: "XSS attempt detected"
          description: "Cross-site scripting attempt from {{ $labels.client_ip }} to {{ $labels.endpoint }}"

      - alert: FileUploadAttack
        expr: increase(malicious_file_upload_attempts_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          category: web
        annotations:
          summary: "Malicious file upload attempt"
          description: "Malicious file upload attempt from {{ $labels.client_ip }}"

      - alert: UnusualAPIAccess
        expr: rate(api_requests_total{endpoint=~"/api/(admin|system|internal).*"}[5m]) > 20
        for: 2m
        labels:
          severity: warning
          category: web
        annotations:
          summary: "Unusual API access pattern"
          description: "High access rate to sensitive API endpoint {{ $labels.endpoint }} from {{ $labels.client_ip }}"

  # Network Security Alerts
  - name: clms.security.network
    rules:
      - alert: PortScanDetected
        expr: increase(firewall_blocked_connections_total[5m]) > 50
        for: 2m
        labels:
          severity: warning
          category: network
        annotations:
          summary: "Port scan detected"
          description: "{{ $value }} blocked connection attempts in last 5 minutes, possible port scan"

      - alert: DDoSAttackDetected
        expr: rate(http_requests_total[1m]) > 1000
        for: 2m
        labels:
          severity: critical
          category: network
        annotations:
          summary: "DDoS attack detected"
          description: "{{ $value }} requests per minute, possible DDoS attack"

      - alert: UnauthorizedAccessAttempt
        expr: increase(unauthorized_access_attempts_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
          category: network
        annotations:
          summary: "Unauthorized access attempts"
          description: "{{ $value }} unauthorized access attempts from {{ $labels.client_ip }}"

      - alert: SuspiciousGeographicAccess
        expr: increase(access_from_suspicious_geo_total[1h]) > 0
        for: 1m
        labels:
          severity: warning
          category: network
        annotations:
          summary: "Access from suspicious geographic location"
          description: "Access from suspicious country {{ $labels.country }} to {{ $labels.service }}"

  # Database Security Alerts
  - name: clms.security.database
    rules:
      - alert: SuspiciousDatabaseQuery
        expr: increase(suspicious_db_queries_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "Suspicious database query detected"
          description: "Suspicious query pattern detected: {{ $labels.query_type }}"

      - alert: DatabaseBackupFailure
        expr: database_backup_success == 0
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Database backup failed"
          description: "Database backup failed to complete successfully"

      - alert: DatabasePrivilegeEscalation
        expr: increase(db_privilege_escalation_attempts_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "Database privilege escalation attempt"
          description: "Privilege escalation attempt detected from {{ $labels.user }}"

  # File System Security Alerts
  - name: clms.security.filesystem
    rules:
      - alert: SuspiciousFileAccess
        expr: increase(suspicious_file_access_total[5m]) > 0
        for: 1m
        labels:
          severity: warning
          category: filesystem
        annotations:
          summary: "Suspicious file access detected"
          description: "Access to sensitive file {{ $labels.file_path }} from {{ $labels.process }}"

      - alert: UnauthorizedFileModification
        expr: increase(unauthorized_file_modifications_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          category: filesystem
        annotations:
          summary: "Unauthorized file modification detected"
          description: "Unauthorized modification to {{ $labels.file_path }} by {{ $labels.user }}"

      - alert: RansomwareActivity
        expr: increase(file_encryption_operations_total[5m]) > 10
        for: 2m
        labels:
          severity: critical
          category: filesystem
        annotations:
          summary: "Potential ransomware activity"
          description: "High number of file encryption operations detected"

  # System Security Alerts
  - name: clms.security.system
    rules:
      - alert: SudoUsageAnomaly
        expr: increase(sudo_commands_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "Unusual sudo usage detected"
          description: "{{ $value }} sudo commands executed by {{ $labels.user }}"

      - alert: NewCronJobDetected
        expr: increase(new_cron_jobs_total[1h]) > 0
        for: 1m
        labels:
          severity: info
          category: system
        annotations:
          summary: "New cron job detected"
          description: "New cron job created by {{ $labels.user }}: {{ $labels.cron_command }}"

      - alert: SystemIntegrityViolation
        expr: increase(system_integrity_violations_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          category: system
        annotations:
          summary: "System integrity violation detected"
          description: "System integrity violation: {{ $labels.violation_type }}"

  # SSL/TLS Security Alerts
  - name: clms.security.ssl
    rules:
      - alert: WeakTLSCipher
        expr: probe_ssl_cipher_info{cipher!~"TLS_(AES|CHACHA).*"} > 0
        for: 5m
        labels:
          severity: warning
          category: ssl
        annotations:
          summary: "Weak TLS cipher detected"
          description: "Weak cipher {{ $labels.cipher }} in use on {{ $labels.instance }}"

      - alert: SSLProtocolVersion
        expr: probe_ssl_version_info{version!~"TLSv1\.[23]"} > 0
        for: 5m
        labels:
          severity: warning
          category: ssl
        annotations:
          summary: "Insecure SSL protocol version"
          description: "Insecure SSL version {{ $labels.version }} in use on {{ $labels.instance }}"

      - alert: SelfSignedCertificate
        expr: probe_ssl_issuer_info{issuer=~".*self.*|localhost|local"} > 0
        for: 10m
        labels:
          severity: info
          category: ssl
        annotations:
          summary: "Self-signed certificate detected"
          description: "Self-signed certificate in use on {{ $labels.instance }}"

  # Container Security Alerts
  - name: clms.security.containers
    rules:
      - alert: ContainerPrivilegeEscalation
        expr: increase(container_privilege_escalation_attempts_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          category: containers
        annotations:
          summary: "Container privilege escalation attempt"
          description: "Privilege escalation attempt in container {{ $labels.container_name }}"

      - alert: SuspiciousContainerActivity
        expr: increase(suspicious_container_processes_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          category: containers
        annotations:
          summary: "Suspicious container activity"
          description: "Suspicious process {{ $labels.process_name }} in container {{ $labels.container_name }}"

      - alert: ContainerImageVulnerability
        expr: container_image_vulnerabilities{severity=~"CRITICAL|HIGH"} > 0
        for: 10m
        labels:
          severity: warning
          category: containers
        annotations:
          summary: "Container image vulnerabilities detected"
          description: "{{ $value }} {{ $labels.severity }} vulnerabilities in container {{ $labels.container_name }}"

  # Compliance Alerts
  - name: clms.security.compliance
    rules:
      - alert: FERPAViolation
        expr: increase(ferpa_violation_events_total[1h]) > 0
        for: 1m
        labels:
          severity: critical
          category: compliance
        annotations:
          summary: "FERPA compliance violation detected"
          description: "FERPA violation: {{ $labels.violation_type }}"

      - alert: DataAccessWithoutAuthorization
        expr: increase(unauthorized_data_access_total[1h]) > 0
        for: 1m
        labels:
          severity: critical
          category: compliance
        annotations:
          summary: "Unauthorized data access detected"
          description: "Unauthorized access to {{ $labels.data_type }} by {{ $labels.user }}"

      - alert: AuditLogGaps
        expr: audit_log_entries_total - time() > 300
        for: 5m
        labels:
          severity: warning
          category: compliance
        annotations:
          summary: "Audit log gaps detected"
          description: "Audit log has not been updated for more than 5 minutes"